<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="ConvertShopPrices"
   author="Ruhsbaar"
   id="a3d0068ddae76a2c1e113ffc"
   language="Lua"
   purpose="Convert shop prices to $A"
   save_state="y"
   date_written="2019-02-22 01:12:18"
   requires="5.04"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   match="^   (\w{1,2}): (.*) for (.*) \(([\w-]+) left\)\.$"
   regexp="y"
   omit_from_output="y"
   send_to="12"
   sequence="100"
   name="convertshopprice"
  >
  <send>
function w2am(data)
      return string.format("%.2f", (data / 400))
end

function parse_price(data)
  local total = 0
  -- Determine what kind of currency we're dealing with
  if string.find(data, 'L') ~= nil then
    -- Lancre
    if string.find(data, 'Lp') then
      local pe = string.match(data, 'Lp (%d+)') * 12
      total = w2am(pe)
    elseif string.find(data, 'Ls') then
      local sh,pe = string.match(data, 'Ls (%d+)|(%d+)')
      total = w2am((sh * 144)+(pe * 12))
    elseif string.find(data, 'LC') then
      local cr,sh,pe = string.match(data, 'LC (%d+)|([%d-]+)|([%d-]+)')
      sh = tonumber(sh) or 0
      pe = tonumber(pe) or 0
      total = w2am((cr * 1728)+(sh * 144)+(pe * 12))
    elseif string.find(data, 'LSov') then
      local so,cr,sh,pe = string.match(data, 'LSov (%d+)|([%d-]+)|([%d-]+)|([%d-]+)')
      print(so, cr, sh, pe)
      cr = tonumber(cr) or 0
      sh = tonumber(sh) or 0
      pe = tonumber(pe) or 0
      total = w2am((so * 20736)+(cr * 1728)+(sh * 144)+(pe * 12))
    elseif string.find(data, 'LH') then
      local he,so,cr,sh,pe = string.match(data, 'LH (%d)|([%d-])|([%d-])|([%d-])|([%d-])')
      so = tonumber(so) or 0 -- deal with "-"
      cr = tonumber(cr) or 0
      sh = tonumber(sh) or 0
      pe = tonumber(pe) or 0
      total = w2am((he * 248832)+(so * 20736)+(cr * 1728)+(sh * 144)+(pe * 12))
    end
  elseif string.find(data, 'G') ~= nil then
    -- Genua
    if string.find(data, 'Gl') then
      local li,ce = string.match(data, "(%d+),(%d+)Gl")
      li = tonumber(li) or 0
      ce = tonumber(ce) or 0
      total = w2am((li * 300)+(ce * 3))
    elseif string.find(data, 'Gf') then
      local fo,li,ce = string.match(data, "(%d+),(%d+),(%d+)Gf")
      total = w2am((fo * 3000)+(li * 300)+(ce * 3))
    elseif string.find(data, 'Gd') then
      local du,fo,li,ce = string.match(data, "(%d+),(%d+),(%d+),(%d+)Gd")
      fo = tonumber(fo) or 0
      li = tonumber(li) or 0
      ce =  tonumber(ce) or 0
      total = w2am((du * 30000)+(fo * 3000)+(li * 300)+(ce * 3))
    end
  elseif string.find(data, 'de') ~= nil or string.find(data, 'S') ~= nil or string.find(data, 'M') ~= nil then
    -- Ephebe
    local de = (string.match(data, "(%d+)de") or 0) * 2
    local s = (string.match(data, "S(%d+)") or 0) * 192
    local m = (string.match(data, "(%d+)M") or 0) * 9600
    total = w2am(m+s+de)
  elseif string.find(data, 'DjToon') ~= nil then
    -- Djelibeybi
    local pt = (string.match(data, "DjToon %d+%.(%d+)") or 0) * 2
    local tn = (string.match(data, "DjToon (%d+)%.%d+") or 0) * 200
    total = w2am(pt+tn)
  elseif string.find(data, 's') ~= nil or string.find(data, 'Rh') ~= nil then
    -- Bes Pelargic
    local sr = (string.match(data, "(%d+)s") or 0) * 4
    local rh = (string.match(data, "(%d+)Rh") or 0) * 480
    total = w2am(sr+rh)
  end

  return total
end

Note("   %1: %2 for %3 (%4 left). [A$" .. parse_price("%3") .. "]")
  </send>
  </trigger>
</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   match="convertprices on"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>EnableTrigger("convertshopprice", true)
Note("Will now display converted shop prices.")</send>
  </alias>
  <alias
   match="convertprices off"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>EnableTrigger("convertshopprice", false)
Note("Will no longer show converted prices.")</send>
  </alias>
</aliases>

<!--  Variables  -->

<variables>
  <variable name="ConvertShopPrices">1</variable>
</variables>

</muclient>
